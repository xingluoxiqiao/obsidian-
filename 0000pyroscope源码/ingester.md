# 本体
1. **Ingester 结构体**：表示 Ingester 服务的实例。它包含了配置信息、日志记录器、存储桶、实例管理、限制配置和 Prometheus 注册器等组件。
2. **New 函数**：用于创建新的 Ingester 实例。它初始化了本地存储桶、生命周期管理器、磁盘清理器等，并返回一个 Ingester 实例。
3. **starting、running 和 stopping 方法**：这些方法实现了服务的启动、运行和停止逻辑。在启动时，Ingester 服务会启动并等待所有子服务健康；在运行时，它会监视子服务的状态变化；在停止时，它会停止所有子服务和实例。
4. **GetOrCreateInstance 方法**：根据租户 ID 获取或创建一个实例。如果指定租户的实例已经存在，则直接返回，否则创建新的实例并加入到实例管理器中。
5. **Push 和 Flush 方法**：分别用于处理来自客户端的推送请求和刷新请求。Push 方法接收并处理客户端发送的性能数据，将其存储到对应的实例中；Flush 方法用于手动触发刷新实例的操作，将数据写入到持久化存储中。
6. **CheckReady 方法**：用于检查 Ingester 服务是否准备就绪，通常用于 Kubernetes 的健康检查。
# instance
1. **instance 结构体**：表示一个 Ingester 实例，包含了 PhlareDB 实例、shipper 实例、日志记录器、注册器、取消函数等信息。
2. **newInstance 函数**：用于创建一个新的 Ingester 实例。它初始化了 PhlareDB 实例，并启动了一个循环 goroutine 来定期执行 shipper 的同步操作。
3. **loop 方法**：是一个 goroutine，用于在实例运行期间循环执行 shipper 的同步操作。它在启动时立即执行一次 shipper 的同步操作，并定期每隔 5 分钟执行一次。
4. **runShipper 方法**：用于执行 shipper 的同步操作。它首先获取 shipper 锁，然后调用 shipper 的 Sync 方法进行同步操作，最后释放 shipper 锁。
5. **Stop 方法**：用于停止实例。它关闭了 PhlareDB 实例，并调用了取消函数取消实例的上下文，等待所有 goroutine 结束。
# shipper
这个 `shipper` 包的作用是监视本地文件系统中的目录，并将它们上传到远程的数据存储中。
它的主要功能包括：
- **Sync 方法**：执行一次同步操作，确保所有未压缩的本地块已经上传到对象存储桶中。它会读取本地目录中的元数据文件，然后检查哪些块已经上传过，哪些需要上传。上传完成后，会更新元数据文件。如果上传过程中出现错误，则会记录日志并返回错误。
- **Timestamps 方法**：返回数据可用的最小时间戳和已成功上传的最高时间戳。它会读取本地目录中的块元数据，然后计算出这些块的时间范围。
- **lazyOverlapChecker 结构体**：用于检查新块是否与现有块重叠。它会首先同步所有远程的块元数据，然后进行重叠检查。这样做是为了避免频繁地与远程存储进行交互，提高效率。
- **Meta 结构体**：定义了用于存储元数据的格式。每个块都会有一个与之对应的元数据文件，用于记录已经上传的块。
- **WriteMetaFile 和 ReadMetaFile 函数**：用于写入和读取元数据文件。
这个包实现了一个重要的功能，即将本地的数据块上传到远程存储中，确保数据的持久化和可用性。
# head
1. **结构体定义**：
    
    - `Head`：主要的结构体，代表了数据库的头部。它包含了日志记录器、指标、停止通道等成员，以及一些用于存储和管理数据的字段和方法。
    - `Table`：接口类型，定义了数据表的基本行为，例如名称、大小、初始化、刷新和关闭等操作。
    - `selectors`：类型别名，表示一组标签选择器。
2. **构造函数**：
    
    - `NewHead`：用于创建一个新的头部实例。它接受配置和租户限制器，并初始化头部的各种属性和数据表。
3. **方法**：
    
    - `Ingest`：用于接收和处理数据摘要的方法，主要功能是将摘要数据写入数据库中。
    - `Flush`：将内存中的数据刷新到磁盘并关闭头部实例的方法。
    - `Move`：将头部目录移动到本地块的方法。
    - `LabelValues`、`LabelNames`、`ProfileTypes`、`Series`：用于处理标签值、标签名称、摘要类型和系列数据的方法。
4. **其他**：
    - 代码中还包含了一些常量定义、变量声明和辅助函数，用于支持上述方法的实现和功能的实现。
# plareDB
