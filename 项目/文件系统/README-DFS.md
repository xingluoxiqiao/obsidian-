# 项目简介
本项目是一个基于SpringCloudAlibaba的分布式文件系统，分为dataserver，client，nameserver， core四个模块，其中，core模块为其余三个模块提供核心支持，定义了诸如全局异常，消息类型等通用实体类和接口，保证client和dataserver间的正常通信，dataserver，client，nameserver均可有若干实例，每个dataserver服务器都会共享出一定存储空间形成共享存储池，经client上传的文件可分块存储至若干dataserver服务器中，由nameserver统一进行管理，每个文件分块均可有若干副本，同时，基于netty+多线程传输，保证文件传输的可靠性和高效性。
# 技术架构
SpringBoot + SpringCloudAlibaba + RocketMQ + ShardingSphere + Redis + MySQL 
# 亮点难点  
分布式文件系统项目旨在充分利用各用户的空闲空间，并以此搭建更为高效可靠的文件系统，因此主要会存在如下问题：
1. **海量并发**：可能会面对大量用户同时访问的情况，尤其在高峰期，这会对系统的性能和响应速度提出很高的要求。  
2. **海量存储**：可能需要存储大量的用户数据以及文件数据，包括数据库、缓存等，需要足够的存储空间和高效的存储管理方案。  
3. **数据安全性**：需要保证用户数据的安全性和隐私，防止未经授权的访问和数据泄露。  
4. **扩展性&可伸缩性**：需要具备良好的扩展性，以应对用户数量和业务规模的增长。 
5. **数据可靠性**：需要保证文件存储以及传输过程中的可靠性，防止文件丢失等可能影响数据安全的情况。
## 大文件分块
在本项目的设计中，如果不对大文件进行分块处理，可能会出现以下问题：
1. 大文件全部存储在某台dataserver，对存储空间的要求过高
2. 传输只能基于流，难以实现多线程操作，效率较低
3. 文件集中处于某几台服务器，即使采用保存副本操作，仍可能出现文件全部丢失
因此，对大文件进行分块处理是非常必要的操作，基于分块后的小文件，采用了以下操作来提升文件传输的效率和保证文件存储的可靠性：
1. **使用缓冲流+线程池**：对于每个小文件，通过字节缓冲流+netty实现其高效传输，同时，对于一个大文件拆分成的若干小文件，采用线程池开辟多线程的方式传输至多个dataserver，大幅提升文件的传输效率
2. **负载均衡**：每个大文件拆分后的小文件的传输以及存储过程由nameserver统一管理，可以采用特定的负载均衡策略降低dataserver的存储压力，并进行元数据保存，提升后续文件获取时的组装合并时的效率
3. **保存副本**：对每个分块均可以保存若干副本，并且各副本可以分散在若干dataserver，极大降低了文件丢失的风险，保证了存储的可靠性
4. **重传机制**：为每个文件生成校验码，文件的传输过程设置重传机制，防止出现网络问题时的文件丢失或错误问题
## 海量存储
本项目的设计中，不但需要保存文件的原始内容和原始数据，在传输，存储等过程中还需要保存特定的文件元数据，这对元数据的设计以及文件的存储提出了很高的要求，同时也加大了文件（块）检索的难度，为此，进行了以下处理：
1. **精心设计元数据格式**：使用自定义雪花算法+62进制，在保证文件id唯一性的同时，减少id的长度和所占用的空间，同时，将创建时间等特殊字段融入id，减少元数据的字段个数，最大程度利用空间
2. **基于缓存提升检索效率**：对经常访问或新加入的文件id及其各分块位置进行缓存操作，极大提升文件检索的效率，同时定期更新缓存，防止缓存数据的堆积
3. **定期删除策略**：在nameserver中设置定时任务，每隔一段时间进行全局检索，对于长期未被访问的文件，逐步减少其副本数量，直至保留唯一副本或完全清除
## 数据可靠性
数据存储的可靠性是一个需要考虑的关键因素，这不仅包括dataserver的容灾和备份等，还应该考虑文件传输过程中的可靠性，为此，进行了以下处理：
1. **数据校验和重传机制**：传输前基于文件内容生成检验码随文件块一并传输，并在dataserver接收到数据时进行校验，若校验不通过或长时间未收到文件块发送重传请求
2. **多线程存储**：校验完成后，开辟新线程在继续接收文件块的同时立即将已经校验完成的文件块写入磁盘，进行持久化保存
3. **保存副本**：对每个分块均保存若干副本，并且各副本可以分散在若干dataserver，极大降低了文件丢失的风险，保证了存储的可靠性
# 技术总结
1. **封装缓存组件**，通过双重判定锁优化特定场景下大量并发查询数据库问题
2. 使用**策略模式+模板模式**设计消息类型及处理器，实现代码复用和可扩展性
3. **自定义雪花算法**机器标识位，解决雪花算法在分布式环境下可能出现的并发生成重复问题
4. 使用ShardingSphere 中间件进行**分表**处理并进行**敏感数据加密**
5. 对大文件进行分块处理，并对每个分块保存若干副本，保证文件**存储可靠性**
6. 底层基于netty和字节缓冲流，结合线程池进行数据传输，保证**传输高效性**
7. 先写数据库再删缓存，保障文件元数据缓存与数据库之间的**数据一致性**功能

